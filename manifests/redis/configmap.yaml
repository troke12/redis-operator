apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
  namespace: default
data:
  redis.conf: |
    # Cluster mode
    cluster-enabled yes
    cluster-config-file nodes.conf
    cluster-node-timeout 5000
    
    # Persistence
    appendonly yes
    appendfsync everysec
    
    # Network
    bind 0.0.0.0
    protected-mode yes
    port 6379
    requirepass CHANGEME_PASSWORD
    masterauth CHANGEME_PASSWORD
    
    # Cluster announce (will be templated by entrypoint)
    cluster-announce-port 6379
    cluster-announce-bus-port 16379
    cluster-preferred-endpoint-type hostname
    
    # Logging
    loglevel notice
    
  entrypoint.sh: |
    #!/bin/sh
    set -e

    # Get pod name and namespace from env (set by StatefulSet)
    POD_NAME="${HOSTNAME}"
    POD_NAMESPACE="${POD_NAMESPACE:-default}"
    POD_IP="${POD_IP:-}"

    # Build hostname for DNS
    CLUSTER_HOSTNAME="${POD_NAME}.redis-headless.${POD_NAMESPACE}.svc.cluster.local"

    # Read password from secret mount
    REDIS_PASSWORD="${REDIS_PASSWORD}"

    # Template redis.conf with actual values
    sed -i "s|requirepass.*|requirepass ${REDIS_PASSWORD}|g" /etc/redis/redis.conf
    sed -i "s|masterauth.*|masterauth ${REDIS_PASSWORD}|g" /etc/redis/redis.conf

    # Use Pod IP for cluster-announce-ip if available (more reliable for cluster meet)
    # This ensures the node announces its IP address which the operator uses
    if [ -n "${POD_IP}" ]; then
      echo "cluster-announce-ip ${POD_IP}" >> /etc/redis/redis.conf
    else
      # Fallback to hostname if POD_IP not set
      echo "cluster-announce-hostname ${CLUSTER_HOSTNAME}" >> /etc/redis/redis.conf
    fi

    # Start Redis
    exec redis-server /etc/redis/redis.conf
