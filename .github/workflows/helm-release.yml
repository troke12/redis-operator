name: Publish Helm Chart

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Package Helm chart
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Require tags like v1.2.3 (no bare "v", no v1 or v1.2)
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Ref '${TAG}' is not a semantic release tag (expected vX.Y.Z). Aborting."
            exit 1
          fi

          VERSION="${TAG#v}"
          if [[ -z "${VERSION}" ]]; then
            echo "Derived VERSION is empty from tag '${TAG}'. Aborting."
            exit 1
          fi
          echo "Using chart version=${VERSION}, appVersion=${VERSION}"

          # Create output directory
          mkdir -p _site

          # Copy documentation files from docs/ folder
          cp -r docs/* _site/

          # Download existing index.yaml from GitHub Pages to preserve chart history
          # Use custom domain troke.id instead of troke12.github.io
          curl -sL http://troke.id/redis-operator/index.yaml -o _site/index.yaml 2>/dev/null || touch _site/index.yaml

          # Download existing chart packages to preserve them
          # Parse index.yaml to get existing chart URLs and download them
          if [[ -s _site/index.yaml ]]; then
            echo "Downloading existing chart packages..."
            # Extract version numbers and download from custom domain
            grep -oP 'redis-operator-[0-9]+\.[0-9]+\.[0-9]+\.tgz' _site/index.yaml | sort -u | while read filename; do
              if [[ ! -f "_site/$filename" ]]; then
                echo "Downloading $filename..."
                curl -sL "http://troke.id/redis-operator/$filename" -o "_site/$filename" || echo "Failed to download $filename"
              fi
            done
          fi

          # Bump Chart.yaml for this package (not committed)
          sed -i -E "s/^version: .*/version: ${VERSION}/" charts/redis-operator/Chart.yaml
          sed -i -E "s/^appVersion: .*/appVersion: \"${VERSION}\"/" charts/redis-operator/Chart.yaml

          # Set image tag in values.yaml to match Docker image tag (no leading "v")
          sed -i -E "s/^  tag: .*/  tag: ${VERSION}/" charts/redis-operator/values.yaml

          # Copy repo README into chart so it is bundled in the .tgz
          cp README.md charts/redis-operator/README.md

          # Package the chart
          helm package charts/redis-operator --destination _site

          # Rebuild index.yaml from all .tgz files in _site
          helm repo index _site --url https://troke12.github.io/redis-operator

          # Create stable link for latest chart
          CHART_TGZ="$(ls -1t _site/redis-operator-*.tgz 2>/dev/null | head -n 1)"
          if [[ -n "${CHART_TGZ}" ]]; then
            CHART_BASENAME="$(basename "${CHART_TGZ}")"
            ln -sf "${CHART_BASENAME}" _site/redis-operator-latest.tgz || true
            echo "Created latest link: redis-operator-latest.tgz -> ${CHART_BASENAME}"
          fi

          echo "=== Published charts ==="
          ls -la _site/*.tgz 2>/dev/null || echo "No charts found"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
