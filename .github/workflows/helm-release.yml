name: Publish Helm Chart

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Validate tag format
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Require tags like v1.2.3 (no bare "v", no v1 or v1.2)
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Ref '${TAG}' is not a semantic release tag (expected vX.Y.Z). Aborting."
            exit 1
          fi

          VERSION="${TAG#v}"
          if [[ -z "${VERSION}" ]]; then
            echo "Derived VERSION is empty from tag '${TAG}'. Aborting."
            exit 1
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Using chart version=${VERSION}, appVersion=${VERSION}"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout gh-pages branch
        run: |
          git checkout gh-pages

      - name: Package new Helm chart
        run: |
          # Switch back to the tagged commit to get chart files
          git checkout ${GITHUB_REF_NAME} -- charts/

          # Bump Chart.yaml for this package
          sed -i -E "s/^version: .*/version: ${VERSION}/" charts/redis-operator/Chart.yaml
          sed -i -E "s/^appVersion: .*/appVersion: \"${VERSION}\"/" charts/redis-operator/Chart.yaml

          # Set image tag in values.yaml to match Docker image tag (no leading "v")
          sed -i -E "s/^  tag: .*/  tag: ${VERSION}/" charts/redis-operator/values.yaml

          # Copy README into chart
          git checkout ${GITHUB_REF_NAME} -- README.md
          cp README.md charts/redis-operator/README.md

          # Package the chart to current directory (gh-pages root)
          helm package charts/redis-operator --destination .

          # Clean up temporary files
          rm -rf charts/ README.md

          echo "=== New chart packaged ==="
          ls -la redis-operator-${VERSION}.tgz

      - name: Update Helm repository index
        run: |
          # Merge with existing index.yaml to preserve chart history
          if [ -f index.yaml ]; then
            helm repo index . --url https://troke.id/redis-operator --merge index.yaml
          else
            helm repo index . --url https://troke.id/redis-operator
          fi

          echo "=== Updated index.yaml ==="
          cat index.yaml

      - name: Commit and push to gh-pages
        run: |
          git add redis-operator-${VERSION}.tgz index.yaml
          git commit -m "Release Helm chart version ${VERSION}"
          git push origin gh-pages
