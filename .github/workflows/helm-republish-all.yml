name: Re-publish All Helm Chart Versions

on:
  workflow_dispatch:
    inputs:
      versions:
        description: 'Comma-separated versions to republish (e.g., 1.0.0,1.1.0,1.1.1)'
        required: true
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  republish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to access all tags

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Republish charts
        run: |
          VERSIONS="${{ inputs.versions }}"
          mkdir -p docs
          
          # Download existing index.yaml
          curl -sL https://troke12.github.io/redis-operator/index.yaml -o docs/index.yaml || touch docs/index.yaml
          
          # Process each version
          IFS=',' read -ra VERSION_ARRAY <<< "${VERSIONS}"
          for VERSION in "${VERSION_ARRAY[@]}"; do
            VERSION=$(echo "${VERSION}" | xargs)  # trim whitespace
            
            echo "Processing version: ${VERSION}"
            
            # Checkout the tag
            git checkout "v${VERSION}" || {
              echo "Warning: Tag v${VERSION} not found, skipping..."
              continue
            }
            
            # Update Chart.yaml and values.yaml
            sed -i -E "s/^version: .*/version: ${VERSION}/" charts/redis-operator/Chart.yaml
            sed -i -E "s/^appVersion: .*/appVersion: \"${VERSION}\"/" charts/redis-operator/Chart.yaml
            sed -i -E "s/^  tag: .*/  tag: ${VERSION}/" charts/redis-operator/values.yaml
            
            # Copy README
            cp README.md charts/redis-operator/README.md
            
            # Package chart
            helm package charts/redis-operator --destination docs
            
            # Update index with merge
            helm repo index docs --url https://troke12.github.io/redis-operator --merge docs/index.yaml
          done
          
          # Create latest symlink pointing to highest version
          LATEST_CHART=$(ls -1t docs/redis-operator-*.tgz | head -n 1)
          LATEST_BASENAME=$(basename "${LATEST_CHART}")
          ln -sf "${LATEST_BASENAME}" docs/redis-operator-latest.tgz || true

      - name: Generate index.html
        run: |
          cat > docs/index.html <<EOF
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>troke12 Helm Repo</title>
              <style>
                body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; margin: 40px; max-width: 900px; }
                code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
                pre { background: #0b1020; color: #e6e6e6; padding: 16px; border-radius: 10px; overflow: auto; }
                a { color: #2563eb; text-decoration: none; }
                a:hover { text-decoration: underline; }
                .hint { color: #374151; }
              </style>
            </head>
            <body>
              <h1>troke12 Helm Repository</h1>
              <p class="hint">Static Helm repo hosted on GitHub Pages.</p>

              <h2>Use</h2>
              <pre><code>helm repo add troke12 https://troke12.github.io/redis-operator
          helm repo update
          helm search repo troke12

          # install
          helm install redis-operator troke12/redis-operator --namespace redis-operator --create-namespace</code></pre>

              <p class="hint">Helm repo URL: https://troke12.github.io/redis-operator</p>
            </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

  deploy:
    needs: republish
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
