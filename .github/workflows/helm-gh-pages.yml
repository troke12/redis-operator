name: Publish Helm Chart to GitHub Pages

on:
  push:
    tags:
      - "v*"
    branches:
      - main
      - master
      - development
    paths:
      - "docs/**"
      - "charts/**"
      - ".github/workflows/helm-gh-pages.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Build documentation site
        run: |
          # Create output directory
          mkdir -p _site

          # Copy documentation files from docs/ folder
          cp -r docs/* _site/

          # Download existing index.yaml from GitHub Pages to preserve chart history
          curl -sL https://troke12.github.io/redis-operator/index.yaml -o _site/index.yaml 2>/dev/null || touch _site/index.yaml

      - name: Package Helm chart
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Require tags like v1.2.3 (no bare "v", no v1 or v1.2)
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Ref '${TAG}' is not a semantic release tag (expected vX.Y.Z). Skipping Helm packaging."
            exit 0
          fi

          VERSION="${TAG#v}"
          if [[ -z "${VERSION}" ]]; then
            echo "Derived VERSION is empty from tag '${TAG}'. Aborting."
            exit 1
          fi
          echo "Using chart version=${VERSION}, appVersion=${VERSION}"

          # Bump Chart.yaml for this package (not committed)
          sed -i -E "s/^version: .*/version: ${VERSION}/" charts/redis-operator/Chart.yaml
          sed -i -E "s/^appVersion: .*/appVersion: \"${VERSION}\"/" charts/redis-operator/Chart.yaml

          # Set image tag in values.yaml to match Docker image tag (no leading "v")
          sed -i -E "s/^  tag: .*/  tag: ${VERSION}/" charts/redis-operator/values.yaml

          # Copy repo README into chart so it is bundled in the .tgz
          cp README.md charts/redis-operator/README.md

          # Package the chart
          helm package charts/redis-operator --destination _site

          # Update index.yaml, merging with existing entries
          helm repo index _site --url https://troke12.github.io/redis-operator --merge _site/index.yaml

          CHART_TGZ="$(ls -1 _site/*.tgz | head -n 1)"
          if [[ -n "${CHART_TGZ}" ]]; then
            CHART_BASENAME="$(basename "${CHART_TGZ}")"
            # stable link for humans/tools
            ln -sf "${CHART_BASENAME}" _site/redis-operator-latest.tgz || true
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
